# Caravel tapeout CI: Init → sim-rtl (verification) → hardening (RTL→GDS) → precheck → collect logs on failure.
# Structure similar to standard Caravel CI: short init, then verification, netlist/hardening, checks, log collection.
name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  PIP_CACHE_DIR: .cache/pip
  DISABLE_DEPRECATED_MAKEFILE_PROMPT: "1"

jobs:
  sim-rtl:
    name: sim-rtl
    timeout-minutes: 720
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pdk: ["sky130A", "sky130B"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: .cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '.github/workflows/*.yml') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install Python
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv
          python3 --version

      - name: Install Python dependencies (venv)
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Dependencies
        run: |
          export PATH="${{ github.workspace }}/venv/bin:$PATH"
          PDK=${{ matrix.pdk }} make setup

      - name: Configure GPIO defaults
        run: |
          python3 scripts/gpio_config.py --set-all GPIO_MODE_USER_STD_INPUT_NOPULL

      - name: Run RTL Verification
        run: |
          PDK=${{ matrix.pdk }} make verify-all-rtl

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: sim-rtl-logs-${{ matrix.pdk }}-${{ github.run_id }}
          path: |
            verilog/dv/
          retention-days: 7

  hardening:
    name: hardening
    timeout-minutes: 720
    runs-on: ubuntu-latest
    needs: [sim-rtl]
    strategy:
      matrix:
        pdk: ["sky130A", "sky130B"]
      fail-fast: false
    env:
      # Run LibreLane/Docker in non-interactive mode (no TTY) so CI does not fail with "input device is not a TTY"
      CI: "true"
      LIBRELANE_DOCKER_NO_TTY: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: .cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '.github/workflows/*.yml') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install Python
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv python3-tk
          python3 --version

      - name: Install Python dependencies (venv)
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Dependencies
        run: |
          export PATH="${{ github.workspace }}/venv/bin:$PATH"
          for i in 1 2 3; do if PDK=${{ matrix.pdk }} make setup; then break; fi; [ "$i" -eq 3 ] && exit 1; echo "Setup attempt $i failed (e.g. PDK download), retrying in 30s..."; sleep 30; done

      - name: Harden Designs (RTL → GDS)
        run: |
          set -e
          python3 .github/scripts/get_designs.py --design ${{ github.workspace }}
          for design in $(cat harden_sequence.txt); do
            [ -z "$design" ] && continue
            PDK=${{ matrix.pdk }} make "$design" || exit 1
          done

      - name: Upload Hardened Design
        uses: actions/upload-artifact@v4
        with:
          name: design-${{ matrix.pdk }}
          path: |
            ${{ github.workspace }}/gds
            ${{ github.workspace }}/signoff
            ${{ github.workspace }}/verilog/gl
            ${{ github.workspace }}/lef
          retention-days: 1

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: hardening-logs-${{ matrix.pdk }}-${{ github.run_id }}
          path: |
            openlane/
            harden_sequence.txt
          if-no-files-found: ignore
          retention-days: 7

  precheck:
    name: precheck
    timeout-minutes: 720
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pdk: ["sky130A", "sky130B"]
      fail-fast: false
    needs: [hardening]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install EDA tools (KLayout, Magic)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            klayout \
            magic \
            netgen \
            libx11-dev \
            tcl-dev \
            tk-dev
          klayout -v || true
          magic -v || true

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: .cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '.github/workflows/*.yml') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install Python
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv
          python3 --version

      - name: Install Python dependencies (venv)
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Dependencies
        run: |
          export PATH="${{ github.workspace }}/venv/bin:$PATH"
          PDK=${{ matrix.pdk }} make install
          PDK=${{ matrix.pdk }} make check-env
          PDK=${{ matrix.pdk }} make install_mcw
          for i in 1 2 3; do if PDK=${{ matrix.pdk }} make pdk-with-ciel; then break; fi; [ "$i" -eq 3 ] && exit 1; echo "PDK download attempt $i failed, retrying in 30s..."; sleep 30; done
          PDK=${{ matrix.pdk }} make precheck

      - name: Download Hardened Design
        uses: actions/download-artifact@v4
        with:
          name: design-${{ matrix.pdk }}
          path: ${{ github.workspace }}

      - name: Configure GPIO defaults
        run: |
          python3 scripts/gpio_config.py --set-all GPIO_MODE_USER_STD_INPUT_NOPULL

      - name: Run Precheck
        run: |
          PDK=${{ matrix.pdk }} make run-precheck

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: precheck-logs-${{ matrix.pdk }}-${{ github.run_id }}
          path: |
            precheck_results/
          retention-days: 7

  collect-logs-on-failure:
    name: Collect logs on failure
    runs-on: ubuntu-latest
    if: failure() && !cancelled()
    needs: [sim-rtl, hardening, precheck]
    steps:
      - name: Summary of failed jobs
        run: |
          echo "One or more jobs failed. Check the Actions run log and job artifacts for details." > failure-summary.txt
          echo "Workflow: ${{ github.workflow }}" >> failure-summary.txt
          echo "Run ID: ${{ github.run_id }}" >> failure-summary.txt
          echo "Branch: ${{ github.ref_name }}" >> failure-summary.txt

      - name: Upload failure summary
        uses: actions/upload-artifact@v4
        with:
          name: failure-summary-${{ github.run_id }}
          path: failure-summary.txt
          retention-days: 7
