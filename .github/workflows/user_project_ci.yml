# Caravel tapeout CI: Init → sim-rtl (verification) → hardening (RTL→GDS) → precheck → collect logs on failure.
# Structure similar to standard Caravel CI: short init, then verification, netlist/hardening, checks, log collection.
name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  PIP_CACHE_DIR: .cache/pip

jobs:
  init:
    name: Init
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: .cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '.github/workflows/*.yml') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install ChipFoundry CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv
          pip3 install chipfoundry-cli

      - name: Initialize project config
        run: |
          mkdir -p .cf
          python3 <<EOF
          import json, os
          from pathlib import Path
          name = os.path.basename(os.getcwd())
          Path('.cf/project.json').write_text(json.dumps({
              "project": {
                  "name": name, "type": "digital", "user": "chipfoundry",
                  "version": "1.0.0", "user_project_wrapper_hash": "", "submission_state": "Draft"
              }
          }, indent=2))
          EOF

      - name: Upload init artifacts
        uses: actions/upload-artifact@v4
        with:
          name: init-cf
          path: .cf/
          retention-days: 1

  sim-rtl:
    name: sim-rtl
    timeout-minutes: 720
    runs-on: ubuntu-latest
    needs: [init]
    strategy:
      matrix:
        pdk: ["sky130A", "sky130B"]
    steps:
      - uses: actions/checkout@v4

      - name: Download init artifacts
        uses: actions/download-artifact@v4
        with:
          name: init-cf
          path: .cf/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: .cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '.github/workflows/*.yml') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install ChipFoundry CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv
          pip3 install chipfoundry-cli

      - name: Setup Dependencies
        run: |
          cf setup --pdk ${{ matrix.pdk }} --only-caravel --only-mcw --only-pdk --only-cocotb

      - name: Configure GPIO (non-interactive)
        run: |
          python3 <<EOF
          import json
          from pathlib import Path
          
          project_json = Path('.cf/project.json')
          with open(project_json) as f:
              data = json.load(f)
          
          # Set default GPIO config (all as user input no pull)
          gpio_config = {}
          for gpio in range(5, 38):
              gpio_config[str(gpio)] = "13'h0402"  # GPIO_MODE_USER_STD_INPUT_NOPULL
          
          data['project']['gpio_config'] = gpio_config
          
          with open(project_json, 'w') as f:
              json.dump(data, f, indent=2)
          EOF

      - name: Run RTL Verification
        run: |
          cf verify --all

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: sim-rtl-logs-${{ matrix.pdk }}-${{ github.run_id }}
          path: |
            .cf/
            verilog/dv/
          retention-days: 7

  hardening:
    name: hardening
    timeout-minutes: 720
    runs-on: ubuntu-latest
    needs: [sim-rtl]
    strategy:
      matrix:
        pdk: ["sky130A", "sky130B"]
      fail-fast: false
    env:
      # Run LibreLane/Docker in non-interactive mode (no TTY) so CI does not fail with "input device is not a TTY"
      CI: "true"
      LIBRELANE_DOCKER_NO_TTY: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: .cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '.github/workflows/*.yml') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install ChipFoundry CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv python3-tk
          pip3 install chipfoundry-cli

      - name: Initialize Project
        run: |
          mkdir -p .cf
          python3 <<EOF
          import json
          import os
          from pathlib import Path
          
          project_name = os.path.basename(os.getcwd())
          project_json = Path('.cf/project.json')
          
          data = {
              "project": {
                  "name": project_name,
                  "type": "digital",
                  "user": "chipfoundry",
                  "version": "1.0.0",
                  "user_project_wrapper_hash": "",
                  "submission_state": "Draft"
              }
          }
          
          with open(project_json, 'w') as f:
              json.dump(data, f, indent=2)
          EOF

      - name: Setup Dependencies
        run: |
          cf setup --pdk ${{ matrix.pdk }} --only-openlane --only-pdk

      - name: Harden Designs (RTL → GDS)
        run: |
          set -e
          python3 .github/scripts/get_designs.py --design ${{ github.workspace }}
          # Use script to provide a pseudo-TTY so LibreLane/Docker does not fail with "input device is not a TTY"
          for design in $(cat harden_sequence.txt); do
            [ -z "$design" ] && continue
            script -q -c "cf harden $design" /dev/null || exit 1
          done

      - name: Upload Hardened Design
        uses: actions/upload-artifact@v4
        with:
          name: design-${{ matrix.pdk }}
          path: |
            ${{ github.workspace }}/gds
            ${{ github.workspace }}/signoff
            ${{ github.workspace }}/verilog/gl
            ${{ github.workspace }}/lef
            ${{ github.workspace }}/.cf/project.json
          retention-days: 1

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: hardening-logs-${{ matrix.pdk }}-${{ github.run_id }}
          path: |
            openlane/*/runs/
            .cf/
            harden_sequence.txt
          retention-days: 7

  precheck:
    name: precheck
    timeout-minutes: 720
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pdk: ["sky130A", "sky130B"]
      fail-fast: false
    needs: [hardening]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install EDA tools (KLayout, Magic)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            klayout \
            magic \
            netgen \
            libx11-dev \
            tcl-dev \
            tk-dev
          klayout -v || true
          magic -v || true

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: .cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '.github/workflows/*.yml') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install ChipFoundry CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv
          pip3 install chipfoundry-cli

      - name: Initialize Project
        run: |
          mkdir -p .cf
          python3 <<EOF
          import json
          import os
          from pathlib import Path
          
          project_name = os.path.basename(os.getcwd())
          project_json = Path('.cf/project.json')
          
          data = {
              "pdk": "${{ matrix.pdk }}",
              "project": {
                  "name": project_name,
                  "type": "digital",
                  "user": "chipfoundry",
                  "version": "1.0.0",
                  "user_project_wrapper_hash": "",
                  "submission_state": "Draft"
              }
          }
          
          with open(project_json, 'w') as f:
              json.dump(data, f, indent=2)
          EOF

      - name: Setup Dependencies
        run: |
          cf setup --pdk ${{ matrix.pdk }} --only-pdk --only-precheck

      - name: Download Hardened Design
        uses: actions/download-artifact@v4
        with:
          name: design-${{ matrix.pdk }}
          path: ${{ github.workspace }}

      - name: Configure GPIO (non-interactive)
        run: |
          python3 <<EOF
          import json
          from pathlib import Path
          
          project_json = Path('.cf/project.json')
          with open(project_json) as f:
              data = json.load(f)
          
          # Set default GPIO config (all as user input no pull)
          gpio_config = {}
          for gpio in range(5, 38):
              gpio_config[str(gpio)] = "13'h0402"  # GPIO_MODE_USER_STD_INPUT_NOPULL
          
          data['project']['gpio_config'] = gpio_config
          
          with open(project_json, 'w') as f:
              json.dump(data, f, indent=2)
          EOF

      - name: Update user_defines.v from GPIO config
        run: |
          python3 <<'PYEOF'
          import json
          import re
          from pathlib import Path
          project_json = Path('.cf/project.json')
          user_defines = Path('verilog/rtl/user_defines.v')
          with open(project_json) as f:
              data = json.load(f)
          gpio_config = data.get('project', {}).get('gpio_config', {})
          if not gpio_config:
              for g in range(5, 38):
                  gpio_config[str(g)] = "13'h0402"
          text = user_defines.read_text()
          for g in range(5, 38):
              val = gpio_config.get(str(g), "13'h0402")
              text = re.sub(
                  r"(`define USER_CONFIG_GPIO_" + str(g) + r"_INIT\s+).*",
                  r"\g<1>" + val,
                  text,
                  count=1,
              )
          user_defines.write_text(text)
          PYEOF

      - name: Run Precheck
        run: |
          cf precheck

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: precheck-logs-${{ matrix.pdk }}-${{ github.run_id }}
          path: |
            precheck_results/
            .cf/
          retention-days: 7

  collect-logs-on-failure:
    name: Collect logs on failure
    runs-on: ubuntu-latest
    if: failure() && !cancelled()
    needs: [init, sim-rtl, hardening, precheck]
    steps:
      - name: Summary of failed jobs
        run: |
          echo "One or more jobs failed. Check the Actions run log and job artifacts for details." > failure-summary.txt
          echo "Workflow: ${{ github.workflow }}" >> failure-summary.txt
          echo "Run ID: ${{ github.run_id }}" >> failure-summary.txt
          echo "Branch: ${{ github.ref_name }}" >> failure-summary.txt

      - name: Upload failure summary
        uses: actions/upload-artifact@v4
        with:
          name: failure-summary-${{ github.run_id }}
          path: failure-summary.txt
          retention-days: 7
