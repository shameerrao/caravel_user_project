# Optional: RTL-to-GDS on self-hosted runner (uses tools on your server).
# Enable after adding a self-hosted runner: Settings → Actions → Runners → New self-hosted runner.
# Label the runner: self-hosted, linux, x64 (and optionally caravel if you want only this job).
name: RTL-to-GDS (Self-hosted)

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  rtl-to-gds:
    timeout-minutes: 720
    runs-on: [self-hosted, linux, x64]
    strategy:
      matrix:
        pdk: [sky130A]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Install ChipFoundry CLI
        run: |
          python3 -m pip install --user --upgrade pip
          pip3 install chipfoundry-cli

      - name: Initialize Project
        run: |
          mkdir -p .cf
          python3 <<EOF
          import json
          import os
          from pathlib import Path
          project_name = os.path.basename(os.getcwd())
          data = {
              "project": {
                  "name": project_name,
                  "type": "digital",
                  "user": "chipfoundry",
                  "version": "1.0.0",
                  "user_project_wrapper_hash": "",
                  "submission_state": "Draft"
              }
          }
          with open('.cf/project.json', 'w') as f:
              json.dump(data, f, indent=2)
          EOF

      - name: Setup PDK and OpenLane
        run: cf setup --pdk ${{ matrix.pdk }} --only-openlane --only-pdk

      - name: Harden designs (RTL → GDS)
        run: |
          set -e
          python3 .github/scripts/get_designs.py --design ${{ github.workspace }}
          for design in $(cat harden_sequence.txt); do
            cf harden $design || exit 1
          done

      - name: Upload GDS and signoff
        uses: actions/upload-artifact@v4
        with:
          name: design-self-hosted-${{ matrix.pdk }}
          path: |
            ${{ github.workspace }}/gds
            ${{ github.workspace }}/signoff
            ${{ github.workspace }}/.cf/project.json
          retention-days: 7
